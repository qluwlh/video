{"version":3,"sources":["App.tsx","reportWebVitals.ts","index.tsx"],"names":["m3u8Parser","require","muxjs","m3u8Urls","static","mp4Urls","test","getTs$","url","defer","axios","get","responseType","pipe","map","item","data","retry","App","useState","loaded","setLoaded","m3u8","setM3u8","mp4","setMp4","transmuxer","useMemo","Transmuxer","mediaSource","MediaSource","sourceBufferRef","useRef","videoRef","updateend","endOfStream","current","play","appendSegment","a","URL","revokeObjectURL","src","addSourceBuffer","on","segment","console","log","Uint8Array","initSegment","byteLength","set","tools","inspect","addEventListener","appendBuffer","useEffect","createObjectURL","task","m3u8File","tss","host","match","parser","Parser","push","end","manifest","segments","uri","format","of","mergeMap","items","forkJoin","catchError","err","error","message","subscribe","next","length","forEach","element","flush","complete","className","onClick","hls","Hls","maxBufferLength","Events","MANIFEST_PARSED","ERROR","event","fatal","type","ErrorTypes","NETWORK_ERROR","startLoad","MEDIA_ERROR","recoverMediaError","destroy","loadSource","attachMedia","name","id","onChange","e","target","value","Object","entries","key","retryWhen","getM3U8$","disabled","width","height","controls","ref","onCanPlay","pause","reportWebVitals","onPerfEntry","Function","then","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"2WAMMA,EAAaC,EAAQ,IACrBC,EAAQD,EAAQ,IAEhBE,EAAW,CACfC,OAAQ,+EACR,iBACE,gGACF,iBACE,iGAGEC,EAAU,CACdC,KAAM,yEACNF,OAAQ,wEACR,iBACE,yFACF,iBACE,0FAQEG,EAAS,SAACC,GAAD,OACbC,aAAM,kBAAMC,IAAMC,IAAIH,EAAK,CAAEI,aAAc,mBAAkBC,KAC3DC,aAAI,SAACC,GAAD,OAAeA,EAAKC,QACxBC,YAAM,MAiLKC,MA9Jf,WAAgB,IAAD,EACeC,oBAAS,GADxB,mBACNC,EADM,KACEC,EADF,OAEWF,mBAAsB,IAFjC,mBAENG,EAFM,KAEAC,EAFA,OAGSJ,mBAAqB,IAH9B,mBAGNK,EAHM,KAGDC,EAHC,KAMPC,EAAaC,mBAAQ,kBAAM,IAAIzB,EAAMsB,IAAII,aAAc,IACvDC,EAAcF,mBAAQ,kBAAM,IAAIG,cAAe,IAC/CC,EAAkBC,iBAAqB,MACvCC,EAAWD,iBAAyB,MACpCE,EAAY,WAAO,IAAD,EACtBL,EAAYM,cACZ,UAAAF,EAASG,eAAT,SAAkBC,OAClBhB,GAAU,IAENiB,EAAa,uCAAG,sBAAAC,EAAA,sDAChBN,EAASG,SACXI,IAAIC,gBAAgBR,EAASG,QAAQM,KAEvCX,EAAgBK,QAAUP,EAAYc,gBAhEhC,6CAiENjB,EAAWkB,GAAG,QAAQ,SAACC,GACrBC,QAAQC,IAAR,uBAAoCF,GACpC,IAAI7B,EAAO,IAAIgC,WAAWH,EAAQI,YAAYC,WAAaL,EAAQ7B,KAAKkC,YACxElC,EAAKmC,IAAIN,EAAQI,YAAa,GAC9BjC,EAAKmC,IAAIN,EAAQ7B,KAAM6B,EAAQI,YAAYC,YAC3CJ,QAAQC,IAAI7C,EAAMsB,IAAI4B,MAAMC,QAAQrC,IACpCe,EAAgBK,QAAQkB,iBAAiB,YAAapB,GACtDH,EAAgBK,QAAQmB,aAAavC,MAZnB,2CAAH,qDAenBwC,qBAAU,WACJvB,EAASG,UACXH,EAASG,QAAQM,IAAMF,IAAIiB,gBAAgB5B,IAE7CA,EAAYyB,iBAAiB,aAAchB,KAC1C,IACH,IAYMoB,EAAO,SAAClD,GAAD,OAAS,SAACmD,GAAc,IAAD,IA1DhBC,EA2DZC,EAAI,oBAAGrD,EAAIsD,MAAM,yBAAb,aAAG,EAA8B,UAAjC,QAAuC,IA3D/BF,EAPP,SAACD,EAAeE,GAC7B,IAAME,EAAS,IAAI/D,EAAWgE,OAI9B,OAHAD,EAAOE,KAAKN,GACZI,EAAOG,MACMH,EAAOI,SAASC,SAAStD,KAAI,qBAAGuD,OAAevD,KAAI,SAACuD,GAAD,gBAAYR,EAAZ,YAAoBQ,MA+DrEC,CAAOX,EAAUE,GA3DhCU,YAAGX,GAAK/C,KACN2D,aAAS,SAACC,GAAD,OACPC,IAAQ,WAAR,cAAYD,EAAM3D,KAAI,SAACC,GAAD,OAAUR,EAAOQ,GAAMF,KAAKC,aAAI,SAACC,GAAD,OAAU,IAAIiC,WAAWjC,eAEjF4D,aAAW,SAACC,GAAD,OAASL,YAAG,CAAEM,OAAO,EAAMC,QAASF,EAAIE,eAuDdC,UAAU,CAC7CC,KAAM,SAAChE,GACL8B,QAAQC,IAAR,2BAAwC/B,IACxC,OAAIA,QAAJ,IAAIA,OAAJ,EAAIA,EAAMiE,UACRjE,EAAKkE,SAAQ,SAACC,GAAD,OAAazD,EAAWuC,KAAKkB,MAC1CzD,EAAW0D,UAGfP,MAAO/B,QAAQC,IACfsC,SAAU,kBAAMvC,QAAQC,IAAI,sBA0ChC,OACE,sBAAKuC,UAAW,OAAhB,UACE,gCACE,wBAAQC,QAlCE,WACd,IAAMC,EAAM,IAAIC,IAAI,CAClBC,gBAAiB,OAEnBF,EAAI5C,GAAG6C,IAAIE,OAAOC,iBAAiB,WAAa,IAAD,EAC7CvE,GAAU,GACV,UAAAY,EAASG,eAAT,SAAkBC,UAGpBmD,EAAI5C,GAAG6C,IAAIE,OAAOE,OAAO,SAAUC,EAAO9E,GACxC,GAAIA,EAAK+E,MACP,OAAQ/E,EAAKgF,MACX,KAAKP,IAAIQ,WAAWC,cAElBpD,QAAQC,IAAI,mDACZyC,EAAIW,YACJ,MACF,KAAKV,IAAIQ,WAAWG,YAClBtD,QAAQC,IAAI,iDACZyC,EAAIa,oBACJ,MACF,QAEEb,EAAIc,cAKZd,EAAIe,WAAWpG,EAASmB,IACxBkE,EAAIgB,YAAYvE,EAASG,UAKrB,wDACA,gCACE,yBAAQqE,KAAMnF,EAAMoF,GAAIpF,EAAMqF,SAAU,SAACC,GAAD,OAAOrF,EAAQqF,EAAEC,OAAOC,QAAhE,UACE,wBAAiBA,MAAO,GAAxB,yBAAa,IAGZC,OAAOC,QAAQ7G,GAAUW,KAAI,mCAAEmG,EAAF,KAAOH,EAAP,YAC5B,wBAAkBA,MAAOG,EAAzB,SACGH,GADUG,SAKjB,wBAAQ1B,QAtDA,WACd,IAAM/E,EAAML,EAASmB,IA3FR,SAACd,GAAD,OACfC,aAAM,kBAAMC,IAAMC,IAAIH,MAAMK,KAC1BC,aAAI,SAACC,GAAD,OAAeA,EAAKC,QACxBkG,aAAU,SAACrC,GAAD,OAAgBA,KAC1BF,aAAW,SAACC,GAAD,OAASL,YAAG,CAAEM,OAAO,EAAMC,QAASF,EAAIE,eAwFnDqC,CAAS3G,GAAKuE,UAAU,CACtBC,KAAMtB,EAAKlD,GACX6E,SAAU,kBAAMvC,QAAQC,IAAI,iBAkDEqE,UAAW9F,EAArC,iCAIF,gCACE,yBAAQmF,KAAMjF,EAAKkF,GAAIlF,EAAKmF,SAAU,SAACC,GAAD,OAAOnF,EAAOmF,EAAEC,OAAOC,QAA7D,UACE,wBAAiBA,MAAO,GAAxB,yBAAa,IAGZC,OAAOC,QAAQ3G,GAASS,KAAI,mCAAEmG,EAAF,KAAOH,EAAP,YAC3B,wBAAkBA,MAAOG,EAAzB,SACGH,GADUG,SAKjB,wBAAQ1B,QA/FD,WAEbhF,EADYF,EAAQmB,IAEjBX,KAAKC,aAAI,SAACC,GAAD,OAAU,IAAIiC,WAAWjC,OAClCgE,UAAU,CACTC,KAAM,SAAChE,GACL8B,QAAQC,IAAR,UAAuB/B,GACvBU,EAAWuC,KAAKjD,GAChBU,EAAW0D,YAuFcgC,UAAW5F,EAApC,mCAKJ,8BACE,uBACEkF,GAAG,QACHW,MAAO,IACPC,OAAQ,IACRhC,UAAU,QACViC,UAAQ,EACRC,IAAKvF,EACLwF,UA3EU,iBA+EbrG,GACC,gCACE,wBAAQmE,QAlJH,kCAAMtD,EAASG,eAAf,aAAM,EAAkBC,QAkJ7B,0BACA,wBAAQkD,QAlJF,kCAAMtD,EAASG,eAAf,aAAM,EAAkBsF,SAkJ9B,iCC9LKC,EAZS,SAACC,GACnBA,GAAeA,aAAuBC,UACxC,6BAAqBC,MAAK,YAAkD,IAA/CC,EAA8C,EAA9CA,OAAQC,EAAsC,EAAtCA,OAAQC,EAA8B,EAA9BA,OAAQC,EAAsB,EAAtBA,OAAQC,EAAc,EAAdA,QAC3DJ,EAAOH,GACPI,EAAOJ,GACPK,EAAOL,GACPM,EAAON,GACPO,EAAQP,OCHdQ,IAASC,OACP,cAAC,IAAMC,WAAP,UACE,cAAC,EAAD,MAEFC,SAASC,eAAe,SAM1Bb,M","file":"static/js/main.67b2c19b.chunk.js","sourcesContent":["import { useEffect, useMemo, useRef, useState } from 'react'\nimport './App.css'\nimport axios from 'axios'\nimport { of, defer, forkJoin } from 'rxjs'\nimport { map, retry, catchError, retryWhen, mergeMap } from 'rxjs/operators'\nimport Hls from 'hls.js'\nconst m3u8Parser = require('m3u8-parser')\nconst muxjs = require('mux.js')\nconst mime = `video/mp4; codecs=\"mp4a.40.2,avc1.64001f\"`\nconst m3u8Urls = {\n  static: 'https://static.uskid.com/playback/20200523/qn5w3mn75/2_6gr4jM07dBixDv4D.m3u8',\n  'oss-accelerate':\n    'https://uskid.oss-accelerate.aliyuncs.com/playback/20200523/qn5w3mn75/2_6gr4jM07dBixDv4D.m3u8',\n  'oss-cn-beijing':\n    'https://uskid.oss-cn-beijing.aliyuncs.com/playback/20200523/qn5w3mn75/2_6gr4jM07dBixDv4D.m3u8',\n}\n\nconst mp4Urls = {\n  test: 'https://hq-static.oss-cn-beijing.aliyuncs.com/videoTest/fragmented.mp4',\n  static: 'https://static.uskid.com/playback/20200523/qn5w3mn75/2_0_merge_av.mp4',\n  'oss-accelerate':\n    'https://uskid.oss-accelerate.aliyuncs.com/playback/20200523/qn5w3mn75/2_0_merge_av.mp4',\n  'oss-cn-beijing':\n    'https://uskid.oss-cn-beijing.aliyuncs.com/playback/20200523/qn5w3mn75/2_0_merge_av.mp4',\n}\nconst getM3U8$ = (url: string) =>\n  defer(() => axios.get(url)).pipe(\n    map((item: any) => item.data),\n    retryWhen((error: any) => error),\n    catchError((err) => of({ error: true, message: err.message }))\n  )\nconst getTs$ = (url: string) =>\n  defer(() => axios.get(url, { responseType: 'arraybuffer' })).pipe(\n    map((item: any) => item.data),\n    retry(10)\n  )\nconst format = (m3u8File: any, host) => {\n  const parser = new m3u8Parser.Parser()\n  parser.push(m3u8File)\n  parser.end()\n  const urls = parser.manifest.segments.map(({ uri }) => uri).map((uri) => `${host}/${uri}`)\n  return urls\n}\nconst getSegments$ = (tss) =>\n  of(tss).pipe(\n    mergeMap((items) =>\n      forkJoin(...items.map((item) => getTs$(item).pipe(map((item) => new Uint8Array(item)))))\n    ),\n    catchError((err) => of({ error: true, message: err.message }))\n  )\n\ntype M3u8UrlKeys = keyof typeof m3u8Urls | ''\ntype Mp4UrlKeys = keyof typeof mp4Urls | ''\nfunction App() {\n  const [loaded, setLoaded] = useState(false)\n  const [m3u8, setM3u8] = useState<M3u8UrlKeys>('')\n  const [mp4, setMp4] = useState<Mp4UrlKeys>('')\n  const play = () => videoRef.current?.play()\n  const pause = () => videoRef.current?.pause()\n  const transmuxer = useMemo(() => new muxjs.mp4.Transmuxer(), [])\n  const mediaSource = useMemo(() => new MediaSource(), [])\n  const sourceBufferRef = useRef<SourceBuffer>(null)\n  const videoRef = useRef<HTMLVideoElement>(null)\n  const updateend = () => {\n    mediaSource.endOfStream()\n    videoRef.current?.play()\n    setLoaded(true)\n  }\n  const appendSegment = async () => {\n    if (videoRef.current) {\n      URL.revokeObjectURL(videoRef.current.src)\n    }\n    sourceBufferRef.current = mediaSource.addSourceBuffer(mime)\n    transmuxer.on('data', (segment) => {\n      console.log(`transmuxer.on(\"data\"`, segment)\n      let data = new Uint8Array(segment.initSegment.byteLength + segment.data.byteLength)\n      data.set(segment.initSegment, 0)\n      data.set(segment.data, segment.initSegment.byteLength)\n      console.log(muxjs.mp4.tools.inspect(data))\n      sourceBufferRef.current.addEventListener('updateend', updateend)\n      sourceBufferRef.current.appendBuffer(data)\n    })\n  }\n  useEffect(() => {\n    if (videoRef.current) {\n      videoRef.current.src = URL.createObjectURL(mediaSource)\n    }\n    mediaSource.addEventListener('sourceopen', appendSegment)\n  }, [])\n  const getMp4 = () => {\n    const url = mp4Urls[mp4]\n    getTs$(url)\n      .pipe(map((item) => new Uint8Array(item)))\n      .subscribe({\n        next: (data) => {\n          console.log(`mp4-url`, data)\n          transmuxer.push(data)\n          transmuxer.flush()\n        },\n      })\n  }\n  const task = (url) => (m3u8File) => {\n    const host = url.match(/(.*)\\/.*.m3u8$/)?.[1] ?? ''\n    getSegments$(format(m3u8File, host)).subscribe({\n      next: (data) => {\n        console.log(`segments$.subscribe-item`, data)\n        if (data?.length) {\n          data.forEach((element) => transmuxer.push(element))\n          transmuxer.flush()\n        }\n      },\n      error: console.log,\n      complete: () => console.log('segments-done'),\n    })\n  }\n  const getM3U8 = () => {\n    const url = m3u8Urls[m3u8]\n    getM3U8$(url).subscribe({\n      next: task(url),\n      complete: () => console.log('data-done'),\n    })\n  }\n  const onCanPlay = () => {}\n  const loadHls = () => {\n    const hls = new Hls({\n      maxBufferLength: 60 * 30,\n    })\n    hls.on(Hls.Events.MANIFEST_PARSED, function () {\n      setLoaded(true)\n      videoRef.current?.play()\n    })\n\n    hls.on(Hls.Events.ERROR, function (event, data) {\n      if (data.fatal) {\n        switch (data.type) {\n          case Hls.ErrorTypes.NETWORK_ERROR:\n            // try to recover network error\n            console.log('fatal network error encountered, try to recover')\n            hls.startLoad()\n            break\n          case Hls.ErrorTypes.MEDIA_ERROR:\n            console.log('fatal media error encountered, try to recover')\n            hls.recoverMediaError()\n            break\n          default:\n            // cannot recover\n            hls.destroy()\n            break\n        }\n      }\n    })\n    hls.loadSource(m3u8Urls[m3u8])\n    hls.attachMedia(videoRef.current)\n  }\n  return (\n    <div className={'root'}>\n      <div>\n        <button onClick={loadHls}>边播放边预加载</button>\n        <div>\n          <select name={m3u8} id={m3u8} onChange={(e) => setM3u8(e.target.value as M3u8UrlKeys)}>\n            <option key={''} value={''}>\n              选择\n            </option>\n            {Object.entries(m3u8Urls).map(([key, value]) => (\n              <option key={key} value={key}>\n                {value}\n              </option>\n            ))}\n          </select>\n          <button onClick={getM3U8} disabled={!m3u8}>\n            获取m3u8\n          </button>\n        </div>\n        <div>\n          <select name={mp4} id={mp4} onChange={(e) => setMp4(e.target.value as Mp4UrlKeys)}>\n            <option key={''} value={''}>\n              选择\n            </option>\n            {Object.entries(mp4Urls).map(([key, value]) => (\n              <option key={key} value={key}>\n                {value}\n              </option>\n            ))}\n          </select>\n          <button onClick={getMp4} disabled={!mp4}>\n            获取mp4\n          </button>\n        </div>\n      </div>\n      <div>\n        <video\n          id=\"video\"\n          width={400}\n          height={300}\n          className=\"video\"\n          controls\n          ref={videoRef}\n          onCanPlay={onCanPlay}\n        />\n      </div>\n\n      {loaded && (\n        <div>\n          <button onClick={play}>播放</button>\n          <button onClick={pause}>暂停</button>\n        </div>\n      )}\n    </div>\n  )\n}\n\nexport default App\n","import { ReportHandler } from 'web-vitals'\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry)\n      getFID(onPerfEntry)\n      getFCP(onPerfEntry)\n      getLCP(onPerfEntry)\n      getTTFB(onPerfEntry)\n    })\n  }\n}\n\nexport default reportWebVitals\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport './index.css'\nimport App from './App'\nimport reportWebVitals from './reportWebVitals'\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n)\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals()\n"],"sourceRoot":""}